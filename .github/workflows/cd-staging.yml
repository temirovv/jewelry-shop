name: CD ‚Äî Staging

on:
  push:
    branches: [develop]

concurrency:
  group: deploy-staging
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    needs: []

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.STAGING_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        env:
          SSH_USER: ${{ secrets.STAGING_SSH_USER }}
          SSH_HOST: ${{ secrets.STAGING_SSH_HOST }}
          PROJECT_PATH: ${{ secrets.STAGING_PROJECT_PATH }}
        run: |
          ssh ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            cd ${{ secrets.STAGING_PROJECT_PATH }}

            echo "==> Pulling latest code..."
            git fetch origin develop
            git reset --hard origin/develop

            echo "==> Building containers..."
            docker compose -f docker-compose.staging.yml build --no-cache

            echo "==> Starting services..."
            docker compose -f docker-compose.staging.yml up -d

            echo "==> Waiting for services to start..."
            sleep 30

            echo "==> Running migrations..."
            docker compose -f docker-compose.staging.yml exec -T backend python manage.py migrate --noinput

            echo "==> Collecting static files..."
            docker compose -f docker-compose.staging.yml exec -T backend python manage.py collectstatic --noinput

            echo "==> Cleaning up old images..."
            docker image prune -f
          ENDSSH

      - name: Health check
        env:
          SSH_USER: ${{ secrets.STAGING_SSH_USER }}
          SSH_HOST: ${{ secrets.STAGING_SSH_HOST }}
          PROJECT_PATH: ${{ secrets.STAGING_PROJECT_PATH }}
        run: |
          ssh ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            cd ${{ secrets.STAGING_PROJECT_PATH }}
            chmod +x scripts/healthcheck.sh
            ./scripts/healthcheck.sh staging
          ENDSSH

      - name: Notify success
        if: success()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_DEPLOY_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="$(cat <<EOF
          ‚úÖ <b>Staging Deploy ‚Äî Muvaffaqiyatli</b>

          üì¶ Branch: <code>develop</code>
          üîó Commit: <code>${{ github.sha }}</code>
          üë§ Author: ${{ github.actor }}
          üïê $(date -u '+%Y-%m-%d %H:%M UTC')
          EOF
          )"

      - name: Notify failure
        if: failure()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_DEPLOY_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="$(cat <<EOF
          ‚ùå <b>Staging Deploy ‚Äî Xatolik!</b>

          üì¶ Branch: <code>develop</code>
          üîó Commit: <code>${{ github.sha }}</code>
          üë§ Author: ${{ github.actor }}
          üîç <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">Loglarni ko'rish</a>
          EOF
          )"
