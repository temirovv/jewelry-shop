name: CD â€” Staging

on:
  push:
    branches: [develop]

concurrency:
  group: deploy-staging
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.STAGING_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        run: |
          ssh ${{ secrets.STAGING_SSH_USER }}@${{ secrets.STAGING_SSH_HOST }} \
            "cd ${{ secrets.STAGING_PROJECT_PATH }} && ./scripts/deploy.sh deploy staging"

      - name: Notify success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_DEPLOY_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âœ… <b>Staging Deploy â€” OK</b>%0A%0AğŸ“¦ <code>develop</code>%0AğŸ”— <code>${{ github.sha }}</code>%0AğŸ‘¤ ${{ github.actor }}"

      - name: Notify failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_DEPLOY_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âŒ <b>Staging Deploy â€” XATO!</b>%0A%0AğŸ“¦ <code>develop</code>%0AğŸ‘¤ ${{ github.actor }}%0AğŸ” <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>Loglar</a>"
