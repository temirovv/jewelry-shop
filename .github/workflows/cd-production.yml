name: CD â€” Production

on:
  push:
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Backup database
        run: |
          ssh ${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }} \
            "cd ${{ secrets.PROD_PROJECT_PATH }} && ./scripts/deploy.sh backup"

      - name: Deploy
        run: |
          ssh ${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }} \
            "cd ${{ secrets.PROD_PROJECT_PATH }} && ./scripts/deploy.sh deploy"

      - name: Notify success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_DEPLOY_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="ğŸš€ <b>Production Deploy â€” OK</b>%0A%0AğŸ“¦ <code>main</code>%0AğŸ”— <code>${{ github.sha }}</code>%0AğŸ‘¤ ${{ github.actor }}"

      - name: Notify failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_DEPLOY_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_DEPLOY_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="ğŸš¨ <b>Production Deploy â€” XATO!</b>%0A%0AğŸ“¦ <code>main</code>%0AğŸ‘¤ ${{ github.actor }}%0AğŸ” <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>Loglar</a>"
